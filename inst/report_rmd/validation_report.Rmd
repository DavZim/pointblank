---
output:
  html_document:
    theme: cosmo
    highlight: kate
    df_print: paged
    include:
      after_body: include_footer.html
---

```{r include=FALSE}
library(dplyr)
library(pointblank)
library(htmltools)
library(knitr)
library(lubridate)
```

```{r read_agent, include=FALSE}
agent <- readRDS("agent.rds")
```

```{r generate_img_files, echo=FALSE}

# Generate the image files in a temporary directory
generate_img_files(agent = agent)

# Get a vector of these file paths
img_file_list <-
  list.files(path = "./temporary_images", pattern = ".*_.svg", full.names = TRUE)
```

## Validation Summary {style="padding-top: 15px"}

`r if (file.exists("include_intro.txt")) { paste(readLines("include_intro.txt", warn = FALSE)) }`

```{r validation_time, echo=FALSE}
knitr::kable(
  dplyr::data_frame(
    `Validation Name` = "Validation",
    #`Validation Time` = paste(gsub("  ", " ", format(Sys.time(), "%A, %B %d, %Y at %l:%M")), toupper(format(Sys.time(), "%p")), collapse = ""),
    `Reporting Time` = paste(gsub("  ", " ", format(Sys.time(), "%A, %B %d, %Y at %l:%M")), toupper(format(Sys.time(), "%p")), collapse = ""),
    #`Validation Duration` = "2 minutes, 23 seconds",
    `All Passed?` = "No"
    ), padding = 1
)
```


```{r report_summary_table, echo=FALSE}
knitr::kable(
  dplyr::data_frame(
    `Tables Interrogated` = agent$validation_set %>% select(tbl_name) %>% distinct() %>% .$tbl_name %>% paste(collapse = ", "),
    `Total Validation Steps` = nrow(agent$validation_set),
    `Steps Passed` = agent$validation_set %>% filter(all_passed == TRUE) %>% nrow(),
    `Steps Failed` = agent$validation_set %>% filter(all_passed == FALSE) %>% nrow())
)
```


```{r layout_images, include=FALSE}
for (i in 1:length(img_file_list)) {
  
  if (i == 1) {
    images <- vector(mode = "character")
  }
  
  images <- 
    c(images,
      structure(
        img(src = img_file_list[i])) %>%
        as.character())
}
```

### Validation Steps {style="padding-bottom: 10px"}

```{r get_preconditions_chr, include=FALSE}

for (i in 1:nrow(agent$validation_set)) {
  
  if (i == 1) preconditions_chr <- vector(mode = "character")
  
  preconditions_chr <-
    c(preconditions_chr,
      ifelse(inherits(agent$validation_set$preconditions[i], "list"),
             paste(unlist(agent$validation_set$preconditions[i]), collapse = ", "),
             paste0("None")))
  
  if (i == nrow(agent$validation_set)) {
    preconditions_chr[which(preconditions_chr == "")] <- "None"
  }
}
```

```{r get_value_regex_strings, include=FALSE}

for (i in 1:nrow(agent$validation_set)) {
  
  if (i == 1) value_chr <- vector(mode = "character")
  
  if (!is.na(agent$validation_set$value[i])) {
    value_chr_line <- paste0("**value** ", as.character(agent$validation_set$value[i]))
  } else if (agent$validation_set$assertion_type[i] == "col_vals_regex") {
    value_chr_line <- paste0("**regex** \"", agent$validation_set$regex[i], "\"")
  } else if (agent$validation_set$assertion_type[i] %in% c("col_vals_in_set", "col_vals_not_in_set")) {
    value_chr_line <- paste0("**set** ", paste(unlist(agent$validation_set$set[i]), collapse = ", "))
  }
 
  value_chr <- c(value_chr, value_chr_line)
}
```


```{r images, echo=FALSE}
knitr::kable(
  dplyr::data_frame(
    `1` = images,
    `2` = "&nbsp;",
    `3` = paste0(
      "**table** ", agent$validation_set$tbl_name, " (", agent$validation_set$db_type, ")<br />",
      "**Assertion type** ", agent$validation_set$assertion_type, "<br />",
      "**Number of individual validations** ", agent$validation_set$n, "<br />",
      "**Pass/Fail Percentages** ",
      paste0(agent$validation_set$f_passed * 100, "%"), " / ",
      paste0(agent$validation_set$f_failed * 100, "%")),
    `4` = "&nbsp;",
    `5` = paste0(
      "**column** ", agent$validation_set$column, "<br />",
      value_chr, "<br />",
      "**preconditions** ", preconditions_chr)
    ), padding = 20, col.names = c("&nbsp;", "&nbsp;", "&nbsp;", "&nbsp;", "&nbsp;")
  )
```

